name: Deploy to Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: |
        # Create test .env file
        cat > .env << EOF
        SLACK_BOT_TOKEN=test-token
        SLACK_SIGNING_SECRET=test-secret
        GITLAB_APPLICATION_ID=test-id
        GITLAB_APPLICATION_SECRET=test-secret
        GITLAB_INSTANCE_URL=https://gitlab.com
        PORT=3000
        NODE_ENV=test
        APP_URL=http://localhost:3000
        DATABASE_PATH=./test.db
        WEBHOOK_SECRET=test-secret
        EOF
        
        # Initialize test database
        npm run setup-db
        
        # Here you can add unit tests when they will be
        echo "âœ… Basic validation passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd /opt/slack-gitlab-bot
          
          # Stop service
          sudo systemctl stop slack-gitlab-bot || true
          
          # Backup database
          ./scripts/backup.sh || true
          
          # Update code
          git pull origin main
          
          # Install dependencies
          npm ci --only=production
          
          # Start service
          sudo systemctl start slack-gitlab-bot
          sudo systemctl enable slack-gitlab-bot
          
          # Check status
          sleep 5
          sudo systemctl status slack-gitlab-bot
          
          echo "ðŸš€ Deployment completed successfully!"
