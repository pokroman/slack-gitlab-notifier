name: Deploy to Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð»
        cat > .env << EOF
        SLACK_BOT_TOKEN=test-token
        SLACK_SIGNING_SECRET=test-secret
        GITLAB_APPLICATION_ID=test-id
        GITLAB_APPLICATION_SECRET=test-secret
        GITLAB_INSTANCE_URL=https://gitlab.com
        PORT=3000
        NODE_ENV=test
        APP_URL=http://localhost:3000
        DATABASE_PATH=./test.db
        WEBHOOK_SECRET=test-secret
        EOF
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        npm run setup-db
        
        # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑŽÐ½Ð¸Ñ‚-Ñ‚ÐµÑÑ‚Ñ‹ ÐºÐ¾Ð³Ð´Ð° Ð¾Ð½Ð¸ Ð±ÑƒÐ´ÑƒÑ‚
        echo "âœ… Basic validation passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd /opt/slack-gitlab-bot
          
          # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ°
          sudo systemctl stop slack-gitlab-bot || true
          
          # Backup Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          ./scripts/backup.sh || true
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°
          git pull origin main
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
          npm ci --only=production
          
          # Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°
          sudo systemctl start slack-gitlab-bot
          sudo systemctl enable slack-gitlab-bot
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
          sleep 5
          sudo systemctl status slack-gitlab-bot
          
          echo "ðŸš€ Deployment completed successfully!"
